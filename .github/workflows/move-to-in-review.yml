name: Auto Move to In Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: read
  repository-projects: write

jobs:
  move-to-in-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Move linked issues to In Review
        uses: actions/github-script@v7
        env:
          PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        with:
          # Importante: usar siempre GITHUB_TOKEN para operaciones en proyectos del repositorio.
          # Usaremos PROJECT_TOKEN (PAT) únicamente para consultar proyectos a nivel usuario/organización.
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const PAT = process.env.PROJECT_TOKEN;
            
            // Pequeño helper para llamar GraphQL con un token específico (por ejemplo, el PAT)
            async function gqlWith(token, query, variables) {
              const res = await fetch('https://api.github.com/graphql', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                  'Accept': 'application/vnd.github+json'
                },
                body: JSON.stringify({ query, variables })
              });
              const data = await res.json();
              if (data.errors && data.errors.length) {
                const msg = data.errors.map(e => e.message).join(' | ');
                const err = new Error(msg);
                err.response = data;
                throw err;
              }
              return data.data;
            }
            
            // Skip if PR is draft
            if (pr.draft) {
              console.log('PR is draft, skipping...');
              return;
            }
            
            console.log(`Processing PR #${pr.number}: ${pr.title}`);
            
            // Extract issue numbers from PR body and title
            const issuePattern = /#(\d+)|(?:clo(?:se|ses|sing|sed)|fix(?:es|ed|ing)?|resolve[sd]?|cloes|close)\s*#(\d+)/gi;
            const text = `${pr.title} ${pr.body || ''}`;
            const matches = [...text.matchAll(issuePattern)];
            const issueNumbers = [...new Set(matches.map(m => m[1] || m[2]).filter(Boolean))];
            
            console.log(`Found ${issueNumbers.length} linked issue(s): ${issueNumbers.join(', ')}`);
            
            if (issueNumbers.length === 0) {
              console.log('No linked issues found');
              return;
            }
            
            // Get repository info
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            // GraphQL query to get ALL projects that include this issue
            // This searches user/org projects and repository projects
            console.log('Searching for projects...');
            
            let project = null;
            let projects = [];
            
            // Try to get user/org projects first (most common for Projects v2)
            try {
              const userProjectsQuery = `
                query($login: String!) {
                  user(login: $login) {
                    projectsV2(first: 20, orderBy: {field: UPDATED_AT, direction: DESC}) {
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              
              // Para proyectos a nivel usuario se requiere PAT con alcance de Projects.
              const userProjectsResult = PAT
                ? await gqlWith(PAT, userProjectsQuery, { login: repoOwner })
                : { user: null };
              
              projects = userProjectsResult.user?.projectsV2?.nodes || [];
              console.log(`Found ${projects.length} user projects`);
            } catch (error) {
              console.log('Not a user account, trying organization...');
              
              // Try organization projects
              try {
                const orgProjectsQuery = `
                  query($login: String!) {
                    organization(login: $login) {
                      projectsV2(first: 20, orderBy: {field: UPDATED_AT, direction: DESC}) {
                        nodes {
                          id
                          title
                          number
                        }
                      }
                    }
                  }
                `;
                
                // Para proyectos a nivel organización también se requiere PAT.
                const orgProjectsResult = PAT
                  ? await gqlWith(PAT, orgProjectsQuery, { login: repoOwner })
                  : { organization: null };
                
                projects = orgProjectsResult.organization?.projectsV2?.nodes || [];
                console.log(`Found ${projects.length} organization projects`);
              } catch (orgError) {
                console.log('Failed to get organization projects:', orgError.message);
              }
            }
            
            // Also try repository-level projects
            try {
              const repoProjectsQuery = `
                query($owner: String!, $repo: String!) {
                  repository(owner: $owner, name: $repo) {
                    projectsV2(first: 10, orderBy: {field: UPDATED_AT, direction: DESC}) {
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              
              const repoProjectsResult = await github.graphql(repoProjectsQuery, {
                owner: repoOwner,
                repo: repoName
              });
              
              const repoProjects = repoProjectsResult.repository?.projectsV2?.nodes || [];
              console.log(`Found ${repoProjects.length} repository projects`);
              projects = [...projects, ...repoProjects];
            } catch (repoError) {
              console.log('Failed to get repository projects:', repoError.message);
            }
            
            if (projects.length === 0) {
              console.log('No Projects v2 found');
              return;
            }
            
            // Use the first project (most recently updated)
            project = projects[0];
            console.log(`Using project: ${project.title} (ID: ${project.id})`);
            
            // Get project fields (including status field)
            const fieldsQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const fieldsResult = await github.graphql(fieldsQuery, {
              projectId: project.id
            });
            
            // Find the Status field
            const statusField = fieldsResult.node.fields.nodes.find(
              field => field.name && field.name.toLowerCase() === 'status'
            );
            
            if (!statusField) {
              console.log('No Status field found in project');
              return;
            }
            
            console.log(`Found Status field (ID: ${statusField.id})`);
            
            // Find "In Review" option
            const inReviewOption = statusField.options.find(
              opt => opt.name.toLowerCase().includes('review')
            );
            
            if (!inReviewOption) {
              console.log('No "In Review" status option found');
              console.log('Available options:', statusField.options.map(o => o.name).join(', '));
              return;
            }
            
            console.log(`Target status: ${inReviewOption.name} (ID: ${inReviewOption.id})`);
            
            // Process each linked issue
            for (const issueNumber of issueNumbers) {
              try {
                console.log(`Processing issue #${issueNumber}...`);
                
                // Get issue node ID
                const issue = await github.rest.issues.get({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: parseInt(issueNumber)
                });
                
                // Find the item in the project and get the issue node id
                const itemQuery = `
                  query($issueNumber: Int!) {
                    repository(owner: "${repoOwner}", name: "${repoName}") {
                      issue(number: $issueNumber) {
                        id
                        projectItems(first: 20) {
                          nodes {
                            id
                            project { id title }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const itemResult = await github.graphql(itemQuery, {
                  issueNumber: parseInt(issueNumber)
                });
                
                const issueNodeId = itemResult.repository.issue?.id;
                let projectItem = itemResult.repository.issue?.projectItems.nodes.find(
                  item => item.project.id === project.id
                );
                
                if (!projectItem) {
                  console.log(`Issue #${issueNumber} is not in project ${project.title}, adding it...`);
                  // Add the issue to the project
                  const addItemMutation = `
                    mutation($projectId: ID!, $contentId: ID!) {
                      addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                        item { id }
                      }
                    }
                  `;
                  const addItemResult = await github.graphql(addItemMutation, {
                    projectId: project.id,
                    contentId: issueNodeId
                  });
                  projectItem = addItemResult.addProjectV2ItemById.item;
                  console.log(`✅ Added issue #${issueNumber} to project. Item ID: ${projectItem.id}`);
                }
                
                console.log(`Found issue #${issueNumber} in project (Item ID: ${projectItem.id})`);
                
                // Update the status field
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: $value
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateMutation, {
                  projectId: project.id,
                  itemId: projectItem.id,
                  fieldId: statusField.id,
                  value: {
                    singleSelectOptionId: inReviewOption.id
                  }
                });
                
                console.log(`✅ Moved issue #${issueNumber} to "${inReviewOption.name}"`);
                
                // Add comment to issue
                await github.rest.issues.createComment({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: parseInt(issueNumber),
                  body: `🔄 This issue has been automatically moved to **${inReviewOption.name}** because PR #${pr.number} was opened.\n\n[View Pull Request](${pr.html_url})`
                });
                
              } catch (error) {
                console.error(`❌ Error processing issue #${issueNumber}:`, error.message);
                console.error(error);
              }
            }
            
            console.log('✨ Automation completed successfully');
